<Project 
  xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <ModuleManifest>Name: $(MSBuildProjectName)</ModuleManifest>
    <ExcludedFiles>**\*.cs;*.csproj*;obj\**;bin\**;Assets.json;Assets\**;Properties\**;*.props;*.targets;.vs\**</ExcludedFiles>
    <ModuleType Condition="'$(ModuleType)' == ''">Module</ModuleType>
  </PropertyGroup>
  <ItemGroup>
    <PackageAssetFiles Include="**\*" Exclude="$(ExcludedFiles)" />
  </ItemGroup>
  <Target Name="ExecuteModuleGulp" BeforeTargets="Build" Condition="'$(ApplicationDirectory)' != '' And Exists('$(ApplicationDirectory)')">
    <Message Text="压缩模块脚本文件: $(MSBuildProjectName)" Importance="high" />
    <Exec Command="gulp build --src $(ApplicationDirectory)\modules\$(MSBuildProjectName)" />
  </Target>
  <Target Name="CheckManifestFile" AfterTargets="Build" Condition="!Exists('$(ModuleType).txt')">
    <Message Text="生成模块定义文件: $(MSBuildProjectName)" Importance="high" />
    <WriteLinesToFile File="obj\$(ModuleType).txt" Lines="$(ModuleManifest)" Overwrite="true" Encoding="utf-8" ContinueOnError="true" />
  </Target>
  <Target Name="CopyPackageAssetFiles" Condition="'$(ApplicationDirectory)' != '' And Exists('$(ApplicationDirectory)')">
    <ItemGroup>
      <ApplicationAssetFiles Include="$(ApplicationDirectory)\modules\$(MSBuildProjectName)\**\*" />
    </ItemGroup>
    <Delete Files="@(ApplicationAssetFiles)" Condition="!Exists('%(RecursiveDir)%(Filename)%(Extension)')" ContinueOnError="true"/>
    <Message Text="打包项目文件: $(MSBuildProjectName)" Importance="high" />
    <Copy SourceFiles="@(PackageAssetFiles)" DestinationFolder="$(ApplicationDirectory)\modules\$(MSBuildProjectName)\%(RecursiveDir)" />
    <Copy SourceFiles="obj\$(ModuleType).txt" DestinationFolder="$(ApplicationDirectory)\modules\$(MSBuildProjectName)" Condition="!Exists('$(ModuleType).txt')" />
  </Target>
  <!-- 自定义的 .props -->
  <ItemGroup>
    <None Include="$(MSBuildThisFileDirectory)Module.Build.props" Pack="true">
      <PackagePath>build\$(TargetFramework)\$(PackageId).props</PackagePath>
    </None>
    <None Include="**\*" Exclude="$(ExcludedFiles)" Pack="true">
      <PackagePath>assets\$(PackageId)\</PackagePath>
    </None>
    <None Include="obj\$(ModuleType).txt" Pack="true" Condition="!Exists('$(ModuleType).txt')">
      <PackagePath>assets\$(PackageId)\$(ModuleType).txt</PackagePath>
    </None>
  </ItemGroup>
</Project>
